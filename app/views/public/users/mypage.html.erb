<div class="container">
  <div class="row" style="margin: 20px;">
    <div class="col-lg-12">
      <h4 style="margin: 0;"><strong>マイページ</strong></h4>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-12">
      <div class="d-flex justify-content-left">
        <h4 style="margin: 0;"><strong>登録情報</strong></h4>
        <%= link_to edit_user_path(current_user), class: "btn btn-success ml-5 mb-2" do %>
          <i class="fas fa-user-cog"></i> 編集する
        <% end %>
      </div>      
    </div>
  </div>

  <div class="row">
    <div class="col-lg-12">
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>ユーザー画像</th>
            <th>名前</th>
            <th>自己紹介文</th>
            <th>メールアドレス</th>
            <th>フォロー数</th>
            <th>フォロワー数</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>
              <% if current_user.image.attached? %>
                <%= image_tag current_user.image, class: "rounded-circle", width: 100, height: 100 %>
              <% else %>
                <%= image_tag "no_image.jpg", class: "rounded-circle", width: 100, height: 100 %>
              <% end %>
            </td>
            <td><%= current_user.name %></td>
            <td><%= current_user.introduction %></td>
            <td><%= current_user.email %></td>
            <td><%= link_to @user.followeds.count, user_followeds_path(@user) %></td>
            <td><%= link_to @user.followers.count, user_followers_path(@user) %></td>
          </tr>
        </tbody>
      </table>
    </div>
   </div>

   <div class="row">
     <div class="col-lg-12">
       <h4><strong>投稿一覧</strong></h4>
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>日付</th>
              <th>内容</th>
              <th>金額</th>
              <th>項目</th>
              <th>コメント数</th>
              <th>いいね数</th>
            </tr>
          </thead>
        <tbody>
          <% @user_posts.each do |post| %>
            <tr>
              <td><%= post.created_at.strftime("%Y年%m月%d日") %></td>
              <td><%= link_to post.content, post_path(post) %></td>
              <td>
                <% price = post.category == "expense" ? "-#{post.price}" : post.price %>
                <%= number_to_currency(price, delimiter: ",") %>
              </td>
              <td><%= post.item.name %></td>
              <td><%= post.post_comments.count %></td>
              <td id="favorite_btn_<%= post.id %>">
                <%= render "public/favorites/btn", post: post %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>


  <div class="row">
    <div class="col-lg-12">
      <h4><strong>１ヶ月間の収入金額と支出金額と収支合計</strong></h4>

        <!-- 月選択フォーム -->
        <form id="monthSelectorForm">
          <div class="form-group">
            <select class="form-control" id="month" name="month">
              <% (0..11).each do |n| %>
                <% month = (Date.today.beginning_of_month - n.months) %>
                <option value="<%= month.strftime("%Y-%m") %>"><%= month.strftime("%Y年%m月") %></option>
              <% end %>
            </select>
          </div>
          <button type="button" class="btn btn-primary" id="selectMonthBtn">月を選択</button>
        </form>

        <!-- 月の収入、支出、収支合計を表示するテーブル -->
        <table class='table table-bordered'>
          <thead>
            <tr>
              <th>日付</th>
              <th>収入</th>
              <th>支出</th>
              <th>収支合計</th>
            </tr>
          </thead>
          <tbody id="monthDataTable">
          </tbody>
        </table>
          

        <canvas id="myLineChart"></canvas>

 

        <script>
          $(document).on('turbolinks:load', function() {
            // 月選択後、データを更新する関数
            function updateDataForMonth(selectedMonth) {
              const selectedDate = new Date(selectedMonth + "-01"); // 選択された月の初日
              const lastDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth() + 1, 0); // 選択された月の最終日
              const daysInMonth = lastDate.getDate();

              let labels = [];
              let incomeData = [];
              let expenseData = [];
              let balanceData = [];

              // テーブルのリセット
              $('#monthDataTable').empty();

              // 月ごとのデータを取得して表示
              for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), day);
                const formattedDate = currentDate.toLocaleString().split('T')[0];

                // データ取得
                $.get({
                  url: '/get_month_data', // 必要に応じてデータを取得するURLを指定
                  // type: 'GET',
                  data: { date: formattedDate }, // 日付をクエリパラメータとして送信
                  success: function(data) {
                    // 成功時にテーブルを更新
                    $('#monthDataTable').append(`
                      <tr>
                        <td>${formattedDate}</td>
                        <td>${data.income.toLocaleString()}</td>
                        <td>${data.expense.toLocaleString()}</td>
                        <td>${data.balance.toLocaleString()}</td>
                      </tr>
                    `);
                  }
                });
              }
            }

            // 「月選択しました」ボタンをクリックした時にデータを更新
            $('#selectMonthBtn').on('click', function() {
              const selectedMonth = $('#month').val(); // 選択された月を取得
              updateDataForMonth(selectedMonth); // 月データを更新
            });
          });
        </script>

    </div>
  </div>

  <div class="row">
    <div class="col-lg-12 d-flex justify-content-center">
      <%= paginate @user_posts %>
    </div>
  </div>

</div>
